#!/bin/bash
set -euo pipefail
# Introduce structured logging using Pino and Python logging.  Applies base64-encoded patch to source files.

patch_b64="KioqIEJlZ2luIFBhdGNoCioqKiBVcGRhdGUgRmlsZTogcGFja2FnZS5qc29uCkBACi0gICAgInR5cGVzY3JpcHQiOiAiNS44LjMiCisgICAgInR5cGVzY3JpcHQiOiAiNS44LjMiLAorICAgICJwaW5vIjogIl45LjAuMCIKKioqIEVuZCBQYXRjaAoqKiogQmVnaW4gUGF0Y2gKKioqIFVwZGF0ZSBGaWxlOiBhbnN3ZXIuanMKQEAKLWNvbnN0IHsgZmFIYW1tZXIgfSA9IHJlcXVpcmUoIkBmb3J0YXdlc29tZS9mcmVlLXNvbGlkLXN2Zy1pY29ucyIpOworY29uc3QgeyBmYUhhbW1lciB9ID0gcmVxdWlyZSgiQGZvcnRhd2Vzb21lL2ZyZWUtc29saWQtc3ZnLWljb25zIik7Citjb25zdCBwaW5vID0gcmVxdWlyZSgicGlubyIpOworCisvLyBJbml0aWFsaXplIHN0cnVjdHVyZWQgbG9nZ2VyCitjb25zdCBsb2dnZXIgPSBwaW5vKCk7CkBACi0oYXN5bmMgKCkgPT4geworKGFzeW5jICgpID0+IHsKKyAgbG9nZ2VyLmluZm8oIlN0YXJ0aW5nIHNsaWRlIGdlbmVyYXRpb24iKTsKQEAKLSAgYXdhaXQgcHB0eC53cml0ZUZpbGUoeyBmaWxlTmFtZTogImFuc3dlci5wcHR4IiB9KTsKKyAgYXdhaXQgcHB0eC53cml0ZUZpbGUoeyBmaWxlTmFtZTogImFuc3dlci5wcHR4IiB9KTsKKyAgbG9nZ2VyLmluZm8oIkZpbmlzaGVkIHNsaWRlIGdlbmVyYXRpb24iKTsKKioqIEVuZCBQYXRjaAoqKiogQmVnaW4gUGF0Y2gKKioqIFVwZGF0ZSBGaWxlOiBjcmVhdGVfbW9udGFnZS5weQpAQAotZnJvbSBQSUwgaW1wb3J0IEltYWdlCitmcm9tIFBJTCBpbXBvcnQgSW1hZ2UKK2ltcG9ydCBsb2dnaW5nCisKKyMgQ29uZmlndXJlIFB5dGhvbiBsb2dnaW5nCitsb2dnaW5nLmJhc2ljQ29uZmlnKGxldmVsPWxvZ2dpbmcuSU5GTykKK2xvZ2dlciA9IGxvZ2dpbmcuZ2V0TG9nZ2VyKF9fbmFtZV9fKQpAQAotZGVmIGNyZWF0ZV9tb250YWdlKGlucHV0X2ZpbGVzOiBsaXN0W3N0cl0sIG91dHB1dF9wYXRoOiBzdHIsIG1heF9zaXplOiBpbnQgPSAyMDQ4KSAtPiBOb25lOgotICAgIGltYWdlcyA9IFtJbWFnZS5vcGVuKGltZ19wYXRoKSBmb3IgaW1nX3BhdGggaW4gaW5wdXRfZmlsZXNdCitkZWYgY3JlYXRlX21vbnRhZ2UoaW5wdXRfZmlsZXM6IGxpc3Rbc3RyXSwgb3V0cHV0X3BhdGg6IHN0ciwgbWF4X3NpemU6IGludCA9IDIwNDgpIC0+IE5vbmU6CisgICAgbG9nZ2VyLmluZm8oIkNyZWF0aW5nIG1vbnRhZ2Ugd2l0aCAlZCBpbnB1dCBpbWFnZXM7IG91dHB1dDogJXMiLCBsZW4oaW5wdXRfZmlsZXMpLCBvdXRwdXRfcGF0aCkKKyAgICBpbWFnZXMgPSBbSW1hZ2Uub3BlbihpbWdfcGF0aCkgZm9yIGltZ19wYXRoIGluIGlucHV0X2ZpbGVzXQpAQAotICAgIGdyaWRfaW1hZ2Uuc2F2ZShvdXRwdXRfcGF0aCkKKyAgICBncmlkX2ltYWdlLnNhdmUob3V0cHV0X3BhdGgpCisgICAgbG9nZ2VyLmluZm8oIk1vbnRhZ2Ugc2F2ZWQgdG8gJXMiLCBvdXRwdXRfcGF0aCkKQEAKLWRlZiBtYWluKCkgLT4gTm9uZToKK2RlZiBtYWluKCkgLT4gTm9uZToKQEAKLSAgICBjcmVhdGVfbW9udGFnZShpbnB1dF9maWxlcywgYXJncy5vdXRwdXQsIGFyZ3MubWF4X3NpemUpCisgICAgY3JlYXRlX21vbnRhZ2UoaW5wdXRfZmlsZXMsIGFyZ3Mub3V0cHV0LCBhcmdzLm1heF9zaXplKQorICAgIGxvZ2dlci5pbmZvKCJNb250YWdlIGNyZWF0aW9uIGNvbXBsZXRlIikKKioqIEVuZCBQYXRjaAo="

# Decode base64 patch, write to temporary file, apply
temp_patch=$(mktemp)
echo "$patch_b64" | base64 -d > "$temp_patch"
apply_patch < "$temp_patch"
rm "$temp_patch"

echo "Structured logging applied."