#!/bin/bash
set -euo pipefail
# Harden the PPTX to image conversion script by adding input validation and error handling.

# Base64-encoded unified diff applying enhancements to pptx_to_img.py
patch_b64="KioqIEJlZ2luIFBhdGNoCioqKiBVcGRhdGUgRmlsZTogcHB0eF90b19pbWcucHkKQEAKLWltcG9ydCBhcmdwYXJzZQotaW1wb3J0IG9zCi1pbXBvcnQgc3VicHJvY2VzcwotaW1wb3J0IHRlbXBmaWxlCi1mcm9tIHR5cGluZyBpbXBvcnQgQW55LCBTZXF1ZW5jZSwgY2FzdAoraW1wb3J0IGFyZ3BhcnNlCitpbXBvcnQgb3MKK2ltcG9ydCBzdWJwcm9jZXNzCitpbXBvcnQgdGVtcGZpbGUKK2ltcG9ydCBzaHV0aWwKK2Zyb20gdHlwaW5nIGltcG9ydCBBbnksIFNlcXVlbmNlLCBjYXN0CkBAIGRlZiByYXN0ZXJpemUocHB0eF9wYXRoOiBzdHIsIG91dF9kaXI6IHN0ciwgZHBpOiBpbnQpIC0+IFNlcXVlbmNlW3N0cl06Ci0gICAgcHB0eF9wYXRoID0gb3MucGF0aC5hYnNwYXRoKHBwdHhfcGF0aCkKLSAgICB3b3JrX2RpciA9IG9zLnBhdGguZGlybmFtZShwcHR4X3BhdGgpCi0gICAgc3VicHJvY2Vzcy5ydW4oCi0gICAgICAgIFsKLSAgICAgICAgICAgICJzb2ZmaWNlIiwKLSAgICAgICAgICAgICItLWhlYWRsZXNzIiwKLSAgICAgICAgICAgICItLWNvbnZlcnQtdG8iLAotICAgICAgICAgICAgInBkZiIsCi0gICAgICAgICAgICAiLS1vdXRkaXIiLAotICAgICAgICAgICAgd29ya19kaXIsCi0gICAgICAgICAgICBwcHR4X3BhdGgsCi0gICAgICAgIF0sCi0gICAgICAgIGNoZWNrPVRydWUsCi0gICAgICAgIHN0ZG91dD1zdWJwcm9jZXNzLkRFVk5VTEwsCi0gICAgICAgIHN0ZGVycj1zdWJwcm9jZXNzLkRFVk5VTEwsCi0gICAgKQotICAgIHBkZl9wYXRoID0gb3MucGF0aC5qb2luKHdvcmtfZGlyLCBmIntvcy5wYXRoLnNwbGl0ZXh0KG9zLnBhdGguYmFzZW5hbWUocHB0eF9wYXRoKSlbMF19LnBkZiIpCisgICAgcHB0eF9wYXRoID0gb3MucGF0aC5hYnNwYXRoKHBwdHhfcGF0aCkKKyAgICB3b3JrX2RpciA9IG9zLnBhdGguZGlybmFtZShwcHR4X3BhdGgpCisgICAgIyBWYWxpZGF0ZSB0aGF0IHRoZSBQUFRYIGV4aXN0cworICAgIGlmIG5vdCBvcy5wYXRoLmlzZmlsZShwcHR4X3BhdGgpOgorICAgICAgICByYWlzZSBGaWxlTm90Rm91bmRFcnJvcihmIlBQVFggZmlsZSBub3QgZm91bmQ6IHtwcHR4X3BhdGh9IikKKworICAgICMgRW5zdXJlIExpYnJlT2ZmaWNlIGlzIGF2YWlsYWJsZQorICAgIGlmIHNodXRpbC53aGljaCgic29mZmljZSIpIGlzIE5vbmU6CisgICAgICAgIHJhaXNlIFJ1bnRpbWVFcnJvcigiJ3NvZmZpY2UnIGNvbW1hbmQgbm90IGZvdW5kOyBwbGVhc2UgaW5zdGFsbCBMaWJyZU9mZmljZSBvciBlbnN1cmUgaXQgaXMgaW4geW91ciBQQVRILiIpCisKKyAgICB0cnk6CisgICAgICAgIHN1YnByb2Nlc3MucnVuKAorICAgICAgICAgICAgWworICAgICAgICAgICAgICAgICJzb2ZmaWNlIiwKKyAgICAgICAgICAgICAgICAiLS1oZWFkbGVzcyIsCisgICAgICAgICAgICAgICAgIi0tY29udmVydC10byIsCisgICAgICAgICAgICAgICAgInBkZiIsCisgICAgICAgICAgICAgICAgIi0tb3V0ZGlyIiwKKyAgICAgICAgICAgICAgICB3b3JrX2RpciwKKyAgICAgICAgICAgICAgICBwcHR4X3BhdGgsCisgICAgICAgICAgICBdLAorICAgICAgICAgICAgY2hlY2s9VHJ1ZSwKKyAgICAgICAgICAgIHN0ZG91dD1zdWJwcm9jZXNzLkRFVk5VTEwsCisgICAgICAgICAgICBzdGRlcnI9c3VicHJvY2Vzcy5ERVZOVUxMLAorICAgICAgICApCisgICAgZXhjZXB0IHN1YnByb2Nlc3MuQ2FsbGVkUHJvY2Vzc0Vycm9yIGFzIGU6CisgICAgICAgIHJhaXNlIFJ1bnRpbWVFcnJvcigiRmFpbGVkIHRvIGNvbnZlcnQgUFBUWCB0byBQREYgdmlhIExpYnJlT2ZmaWNlIikgZnJvbSBlCisKKyAgICBwZGZfcGF0aCA9IG9zLnBhdGguam9pbih3b3JrX2RpciwgZiJ7b3MucGF0aC5zcGxpdGV4dChvcy5wYXRoLmJhc2VuYW1lKHBwdHhfcGF0aCkpWzBdfS5wZGYiKQorCisgICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKHBkZl9wYXRoKToKKyAgICAgICAgcmFpc2UgUnVudGltZUVycm9yKCJGYWlsZWQgdG8gcHJvZHVjZSBQREYgZm9yIG92ZXJmbG93IGRldGVjdGlvbi4iKQoqKiogRW5kIFBhdGNoCg=="

# Decode and apply
temp_patch=$(mktemp)
echo "$patch_b64" | base64 -d > "$temp_patch"
apply_patch < "$temp_patch"
rm "$temp_patch"

echo "Harden script applied."